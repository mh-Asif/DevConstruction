@inject IHttpContextAccessor Accessor
@{
}
<div class="container-fluid mt-4 page-content-section content-wrapper">
    <!-- Content -->
    <div class="flex-grow-1">
        <!-- DataTable with Buttons -->
        <div class="row">
            <div class="col-12">
            </div>
        </div>
        <div class="card px-2">
            <div class="d-flex flex-wrap py-2 justify-content-between">
                <h4 class="mb-0">
                    <span class="p-0 pl-2 fw-bold">All Items</span>
                </h4>
                <div class="text-end">
                    <a href="javascript:void(0)" class="btn btn-primary me-sm-3 me-1 addShow" id="btnAddItem">Create Item</a>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="row mb-3 px-3 pt-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Search:</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by item name or unit..." />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" id="btnClearSearch" class="btn btn-secondary">
                        <i class="bx bx-refresh me-1"></i>Clear
                    </button>
                </div>
            </div>

            <div class="card-datatable table-responsive border-top pt-0">
                <table class="master-datatable main-table table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Unit</th>
                            <th>Unit Reorder</th>
                            <th>Created Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal to Add/Edit Item -->
        <div class="modal fade" id="addEditItemModal" tabindex="-1" aria-labelledby="addEditItemModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="addEditItemModalLabel">
                            <i class="bx bx-package me-2"></i><span id="modalTitle">Add Item</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="itemForm">
                        <div class="modal-body p-4">
                            <input type="hidden" id="itemId" value="0" />
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">Item Name <span class="text-danger">*</span></label>
                                    <input type="text" id="itemName" name="itemName" class="form-control" placeholder="Enter item name" required />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Unit <span class="text-danger">*</span></label>
                                    <input type="text" id="itemUnit" name="itemUnit" class="form-control" placeholder="e.g., kg, pcs, m, L" required />
                                    <small class="text-muted">Unit of measurement (kg, pcs, m, L, etc.)</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Reorder Level <span class="text-danger">*</span></label>
                                    <input type="number" id="itemUnitCost" name="itemUnitCost" class="form-control" placeholder="0" step="10" min="0" required />
                                    <small class="text-muted">Minimum threshold</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-bold">Status</label>
                                    <select id="itemStatus" name="itemStatus" class="form-select">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="btnSaveItem">Save Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- / Content -->
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        // Store items data
        var allItemsData = [];
        
        // Initialize DataTable
        var table = $('.master-datatable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "https://cmsapi.hrclicks.com/api/InventoryAPI/GetAllItems",
                "type": "GET",
                "dataType": "json",
                "dataSrc": function (json) {
                    console.log('API Response:', json);
                    if (json && json.itemsList) {
                        allItemsData = json.itemsList; // Store all items
                        return json.itemsList;
                    }
                    return [];
                },
                "error": function (xhr, error, thrown) {
                    console.error('Error loading items:', error);
                    alert('Error loading items. Please try again.');
                }
            },
            "columns": [
                {
                    "data": "item_Name",
                    "render": function (data, type, row) {
                        return data || 'N/A';
                    }
                },
                {
                    "data": "item_Unit",
                    "render": function (data, type, row) {
                        return data || 'N/A';
                    }
                },
                {
                    "data": "item_Reorder_Level",
                    "render": function (data, type, row) {
                        var cost = parseInt(data) || 0;
                        return  cost;
                    }
                },
                {
                    "data": "item_Created_At",
                    "render": function (data, type, row) {
                        if (!data) return 'N/A';
                        
                        // Parse the date and format it
                        var date = new Date(data);
                        if (isNaN(date.getTime())) return data;
                        
                        // Format as DD/MM/YYYY
                        var day = ("0" + date.getDate()).slice(-2);
                        var month = ("0" + (date.getMonth() + 1)).slice(-2);
                        var year = date.getFullYear();
                        
                        return day + '/' + month + '/' + year;
                    }
                },
                {
                    "data": "isActive",
                    "render": function (data, type, row) {
                        if (data === true || data === 1) {
                            return '<span class="badge bg-success">Active</span>';
                        } else {
                            return '<span class="badge bg-danger">Inactive</span>';
                        }
                    }
                },
                {
                    "data": "itemId",
                    "orderable": false,
                    "render": function (data, type, row) {
                        return '<div class="d-inline-block">' +
                            '<a href="javascript:void(0)" class="btn btn-sm btn-warning me-1 edit-item" data-item-id="' + data + '">Edit</a>' +
                            '<a href="javascript:void(0)" class="btn btn-sm btn-danger delete-item" data-item-id="' + data + '">Delete</a>' +
                            '</div>';
                    }
                }
            ],
            "order": [[0, "asc"]],
            "pageLength": 10,
            "language": {
                "emptyTable": "No items found",
                "loadingRecords": "Loading items...",
                "processing": "Processing..."
            }
        });

        // Handle search input
        $('#searchInput').on('keyup', function () {
            table.search(this.value).draw();
        });

        // Handle Clear Search button click
        $(document).on('click', '#btnClearSearch', function () {
            $('#searchInput').val('');
            table.search('').draw();
        });

        // Handle Add Item button click
        $(document).on('click', '#btnAddItem', function () {
            $('#modalTitle').text('Add Item');
            $('#itemId').val('0');
            $('#itemForm')[0].reset();
            $('#itemStatus').val('true');
            showModal();
        });

        // Handle Edit button click
        $(document).on('click', '.edit-item', function () {
            var itemId = $(this).data('item-id');
            editItem(itemId);
        });

        // Function to edit item
        function editItem(itemId) {
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/GetItemById?itemId=' + itemId,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response && response.itemId) {
                        // Populate form with item data
                        $('#itemId').val(response.itemId);
                        $('#itemName').val(response.item_Name || '');
                        $('#itemUnit').val(response.item_Unit || '');
                        $('#itemUnitCost').val(response.item_Reorder_Level || 0);
                        $('#itemStatus').val(response.isActive === true ? 'true' : 'false');
                        
                        $('#modalTitle').text('Edit Item');
                        showModal();
                    } else {
                        alert('Item details not found');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading item:', error);
                    alert('An error occurred while loading item details. Please try again.');
                }
            });
        }

        // Handle Delete button click
        $(document).on('click', '.delete-item', function () {
            var itemId = $(this).data('item-id');
            deleteItem(itemId);
        });

        // Function to delete item
        function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/DeleteItem',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(itemId),
                success: function (response) {
                    if (response.httpStatusCode === 200) {
                        alert('Item deleted successfully!');
                        table.ajax.reload();
                    } else {
                        alert('Error deleting item: ' + (response.displayMessage || 'Unknown error'));
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error deleting item:', error);
                    alert('An error occurred while deleting the item. Please try again.');
                }
            });
        }

        // Handle form submission
        $(document).on('submit', '#itemForm', function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Validate required fields
            var itemName = $('#itemName').val();
            var itemUnit = $('#itemUnit').val();
            var itemUnitCost = $('#itemUnitCost').val();

            if (!itemName || itemName.trim() === '') {
                alert('Please enter item name');
                return;
            }

            if (!itemUnit || itemUnit.trim() === '') {
                alert('Please enter unit');
                return;
            }

            if (!itemUnitCost || parseInt(itemUnitCost) < 0) {
                alert('Please enter a unit of reorder');
                return;
            }

            // Get item ID (0 for new item, actual ID for update)
            var itemIdValue = parseInt($('#itemId').val()) || 0;
            
            // Prepare the item data
            var itemData = {
                itemId: itemIdValue,
                Item_Name: itemName.trim(),
                Item_Unit: itemUnit.trim(),
                Item_Reorder_Level: parseInt(itemUnitCost),
                IsActive: $('#itemStatus').val() === 'true'
            };

            // Show loading state
            var submitBtn = $('#btnSaveItem');
            submitBtn.prop('disabled', true).text('Saving...');

            // Call the API
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/SaveItem',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(itemData),
                success: function (response) {
                    if (response.httpStatusCode === 200) {
                        var message = itemIdValue > 0 ? 'Item updated successfully!' : 'Item saved successfully!';
                        alert(message);
                        
                        // Close modal
                        if (typeof bootstrap !== 'undefined') {
                            var modalEl = document.getElementById('addEditItemModal');
                            var modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                        } else {
                            $('#addEditItemModal').modal('hide');
                        }
                        
                        // Reload table
                        table.ajax.reload();
                    } else {
                        var errorMessage = itemIdValue > 0 ? 'Error updating item' : 'Error saving item';
                        alert(errorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    alert('An error occurred while saving the item. Please try again.');
                },
                complete: function () {
                    // Re-enable button
                    submitBtn.prop('disabled', false).text('Save Item');
                }
            });
        });

        // Function to show modal
        function showModal() {
            if (typeof bootstrap !== 'undefined') {
                // Bootstrap 5
                var modal = new bootstrap.Modal(document.getElementById('addEditItemModal'));
                modal.show();
            } else {
                // Bootstrap 4 or jQuery
                $('#addEditItemModal').modal('show');
            }
        }
    });
</script>
