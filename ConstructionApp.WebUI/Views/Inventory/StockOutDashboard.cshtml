@inject IHttpContextAccessor Accessor
@{
}
<div class="container-fluid mt-4 page-content-section content-wrapper">
    <!-- Content -->
    <div class="flex-grow-1">
        <!-- DataTable with Buttons -->
        <div class="row">
            <div class="col-12">
            </div>
        </div>
        <div class="card px-2">
            <div class="d-flex flex-wrap py-2 justify-content-between">
                <h4 class="mb-0">
                    <span class="p-0 pl-2 fw-bold">Stock Out Transactions</span>
                </h4>
                <div class="text-end">
                    <a href="javascript:void(0)" class="btn btn-primary me-sm-3 me-1 addShow" id="btnAddTransaction">Add Stock Out</a>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="row mb-3 px-3 pt-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Item:</label>
                    <select id="filterItem" class="form-select">
                        <option value="">All Items</option>
                    </select>
                </div>
             
                <div class="col-md-3">
                    <label class="form-label fw-bold">From Date:</label>
                    <input type="date" id="fromDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">To Date:</label>
                    <input type="date" id="toDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <button type="button" id="btnClearFilter" class="btn btn-secondary">
                        <i class="bx bx-refresh"></i>
                    </button>
                </div>
            </div>

            <div class="card-datatable table-responsive border-top pt-0">
                <table class="master-datatable main-table table">
                    <thead>
                        <tr>
                            <th>Transaction Date</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Project Name</th>
                            <th>Task Name</th>
                           @*  <th>Status</th> *@
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal to Add/Edit Transaction -->
        <div class="modal fade" id="addEditTransactionModal" tabindex="-1" aria-labelledby="addEditTransactionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="addEditTransactionModalLabel">
                            <i class="bx bx-export me-2"></i><span id="modalTitle">Add Stock Out Transaction</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="transactionForm">
                        <div class="modal-body p-4">
                            <input type="hidden" id="transactionId" value="0" />
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Item <span class="text-danger">*</span></label>
                                    <select id="itemId" name="itemId" class="form-select" required>
                                        <option value="">Select Item</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Vendor <span class="text-danger">*</span></label>
                                    <select id="vendorId" name="vendorId" class="form-select" required>
                                        <option value="">Select Vendor</option>
                                    </select>
                                   @*  <small class="text-muted">Optional - for stock purchases</small> *@
                                </div>
                               
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Transaction Date</label>
                                    <input type="date" id="transactionDate" name="transactionDate" class="form-control date-picker" />
                                    <small class="text-muted">Leave blank for today's date</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Quantity (Total Quantity :<label id="lblQuantity"></label>) <span class="text-danger">*</span></label>
                                    <input type="number" id="quantity" name="quantity" class="form-control" placeholder="0" min="0" required />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Project<span class="text-danger">*</span></label>
                                    <select id="projectId" name="projectId" class="form-select" required >
                                        <option value="0">Select Project</option>
                                    </select>
                                  @*   <small class="text-muted">Optional - for project allocation</small> *@
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Task</label>
                                    <select id="taskId" name="taskId" class="form-select">
                                        <option value="0">Select Task</option>
                                    </select>
                                   @*  <small class="text-muted">Optional - for task allocation</small> *@
                                </div>
                            </div>

                          
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="btnSaveTransaction">Save Transaction</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- / Content -->
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        // Store transactions data
        var allTransactionsData = [];
        var allItems = [];
        var allProjects = [];
        var allTasks = [];
        
        // Load Items dropdown
        function loadItems() {
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/GetActiveItems',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response && response.itemsList) {
                        allItems = response.itemsList;
                        var $itemSelect = $('#itemId');
                        var $filterItemSelect = $('#filterItem');
                        
                        // Populate main dropdown
                        $itemSelect.empty().append('<option value="">Select Item</option>');
                        $.each(allItems, function (index, item) {
                            $itemSelect.append($('<option></option>').val(item.itemId).text(item.item_Name));
                        });
                        
                        // Populate filter dropdown
                        $filterItemSelect.empty().append('<option value="">All Items</option>');
                        $.each(allItems, function (index, item) {
                            $filterItemSelect.append($('<option></option>').val(item.itemId).text(item.item_Name));
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading items:', error);
                }
            });
        }

        // Load Projects dropdown
        function loadProjects() {
            var unitId = @Accessor.HttpContext.Session.GetInt32("UnitId");
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/ProjectAPI/GetProjects?unitId=' + unitId,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response && response.length > 0) {
                        allProjects = response;
                        var $projectSelect = $('#projectId');
                        var $filterProjectSelect = $('#filterProject');
                        
                        // Populate main dropdown
                        $projectSelect.empty().append('<option value="0">Select Project</option>');
                        $.each(allProjects, function (index, project) {
                            $projectSelect.append($('<option></option>').val(project.projectId).text(project.projectName));
                        });
                        
                        // Populate filter dropdown
                        $filterProjectSelect.empty().append('<option value="0">All Projects</option>');
                        $.each(allProjects, function (index, project) {
                            $filterProjectSelect.append($('<option></option>').val(project.projectId).text(project.projectName));
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading projects:', error);
                }
            });
        }

        // Load Tasks dropdown based on selected project
        function loadTasks(projectId) {
            if (!projectId || projectId == 0) {
                $('#taskId').empty().append('<option value="0">Select Task</option>');
                allTasks = [];
                return;
            }
            
            //var unitId = @Accessor.HttpContext.Session.GetInt32("UserId");
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/TaskAPI/GetTaskByProject?projectId='+projectId,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    console.log(response.taskList.length)
                    if (response.taskList.length > 0) {
                        allTasks = response.taskList;
                        var $taskSelect = $('#taskId');
                        $taskSelect.empty().append('<option value="0">Select Task</option>');
                        $.each(allTasks, function (index, task) {
                            $taskSelect.append($('<option></option>').val(task.taskId).text(task.taskName));
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading tasks:', error);
                }
            });
        }
        function loadVendors() {
            var unitId = @Accessor.HttpContext.Session.GetInt32("UnitId");
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/UsersAPI/GetUsers?UserType=3&unitId=' + unitId,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response && response.length > 0) {
                        allVendors = response;
                        var $vendorSelect = $('#vendorId');
                        $vendorSelect.empty().append('<option value="0">Select Vendor</option>');
                        $.each(allVendors, function (index, vendor) {
                            // Use BusinessOwner or FullName for display
                            var displayName = vendor.businessOwner || vendor.fullName || (vendor.firstName + ' ' + vendor.lastName);
                            displayName = displayName.trim() || 'Vendor #' + vendor.userId;
                            $vendorSelect.append($('<option></option>').val(vendor.userId).text(displayName));
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading vendors:', error);
                }
            });
        }

        function getQuantity(itemid,vendorid) {
          //  var unitId = @Accessor.HttpContext.Session.GetInt32("UnitId");
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/GetStockTransactionsByItemVendor?itemId=' + itemid + '&vendorId=' + vendorid,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.stockTransactionsList.length > 0) {

                        
                        var totalQuantity = response.stockTransactionsList[0].quantity;
                        $('#lblQuantity').html(totalQuantity);
                        $('#quantity').val(totalQuantity);

                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading vendors:', error);
                }
            });
        }
        // Handle project selection change
        $('#projectId').on('change', function () {
            var selectedProjectId = $(this).val();
            loadTasks(selectedProjectId);
        });
        // Handle project selection change
        $('#vendorId').on('change', function () {
            var selectedVendorId = $(this).val();
            var selecteditemId = $('#itemId').val();
           //  alert(selectedVendorId);
           // alert(selecteditemId);
            getQuantity(selecteditemId, selectedVendorId);
        });

        // Initialize dropdowns
        loadItems();
        loadVendors();
        loadProjects();

        // Custom date range filter function for DataTable
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var filterItem = $('#filterItem').val();
                var filterProject = $('#filterProject').val();
                var fromDate = $('#fromDate').val();
                var toDate = $('#toDate').val();
                
                // Get the transaction row from allTransactionsData
                var transaction = allTransactionsData[dataIndex];
                if (!transaction) {
                    return false;
                }
                
                // Filter by item
                if (filterItem && transaction.itemId != filterItem) {
                    return false;
                }
                
                // Filter by project
                if (filterProject && transaction.projectId != filterProject) {
                    return false;
                }
                
                // If no dates are selected, show all rows
                if (!fromDate && !toDate) {
                    return true;
                }
                
                // Get transaction date
                var transactionDateStr = transaction.transactionId;
                if (!transactionDateStr) {
                    return false;
                }
                
                // Parse the transaction date
                var transactionDate = new Date(transactionDateStr);
                if (isNaN(transactionDate.getTime())) {
                    return false;
                }
                transactionDate.setHours(0, 0, 0, 0);
                
                var filterFromDate = fromDate ? new Date(fromDate) : null;
                if (filterFromDate) filterFromDate.setHours(0, 0, 0, 0);
                
                var filterToDate = toDate ? new Date(toDate) : null;
                if (filterToDate) filterToDate.setHours(23, 59, 59, 999);
                
                var matchesFromDate = !filterFromDate || transactionDate >= filterFromDate;
                var matchesToDate = !filterToDate || transactionDate <= filterToDate;
                
                return matchesFromDate && matchesToDate;
            }
        );
        
        // Initialize DataTable
        var table = $('.master-datatable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "https://cmsapi.hrclicks.com/api/InventoryAPI/GetAllStockOutTransactions",
                "type": "GET",
                "dataType": "json",
                "dataSrc": function (json) {
                    console.log('API Response:', json);
                    if (json && json.stockOutList) {
                        allTransactionsData = json.stockOutList;
                        return json.stockOutList;
                    }
                    return [];
                },
                "error": function (xhr, error, thrown) {
                    console.error('Error loading transactions:', error);
                    alert('Error loading transactions. Please try again.');
                }
            },
            "columns": [
                {
                    "data": "transactionId",
                    "render": function (data, type, row) {
                        if (!data) return 'N/A';
                        
                        var date = new Date(data);
                        if (isNaN(date.getTime())) return data;
                        
                        var day = ("0" + date.getDate()).slice(-2);
                        var month = ("0" + (date.getMonth() + 1)).slice(-2);
                        var year = date.getFullYear();
                        
                        return day + '/' + month + '/' + year;
                    }
                },
                {
                    "data": "itemId",
                    "render": function (data, type, row) {
                        // Find item name from allItems array
                        var item = allItems.find(i => i.itemId === data);
                        return item ? item.item_Name : 'N/A';
                    }
                },
                {
                    "data": "quantity",
                    "render": function (data, type, row) {
                        return data ? parseFloat(data).toFixed(0) : '0';
                    }
                },
                {
                    "data": "projectId",
                    "render": function (data, type, row) {
                        if (!data) return 'N/A';
                        // Find project name from allProjects array
                        var project = allProjects.find(p => p.projectId === data);
                        return project ? project.projectName : 'N/A';
                    }
                },
                {
                    "data": "taskId",
                    "render": function (data, type, row) {
                        if (!data) return 'N/A';
                        // Find task name from allTasks array
                        var task = allTasks.find(t => t.taskId === data);
                        return task ? task.taskName : 'Task #' + data;
                    }
                },
                // {
                //     "data": "isActive",
                //     "render": function (data, type, row) {
                //         if (data === true || data === 1) {
                //             return '<span class="badge bg-success">Active</span>';
                //         } else {
                //             return '<span class="badge bg-danger">Inactive</span>';
                //         }
                //     }
                // },
                {
                    "data": "id",
                    "orderable": false,
                    "render": function (data, type, row) {
                        return '<div class="d-inline-block">' +
                            '<a href="javascript:void(0)" class="btn btn-sm btn-warning me-1 edit-transaction" data-transaction-id="' + data + '">Edit</a>' +
                            '<a href="javascript:void(0)" class="btn btn-sm btn-danger delete-transaction" data-transaction-id="' + data + '">Delete</a>' +
                            '</div>';
                    }
                }
            ],
            "order": [[0, "desc"]],
            "pageLength": 10,
            "language": {
                "emptyTable": "No transactions found",
                "loadingRecords": "Loading transactions...",
                "processing": "Processing..."
            }
        });

        // Handle filter changes
        $('#filterItem, #filterProject, #fromDate, #toDate').on('change', function () {
            table.draw();
        });

        // Handle Clear Filter button click
        $(document).on('click', '#btnClearFilter', function () {
            $('#filterItem').val('');
            $('#filterProject').val('');
            $('#fromDate').val('');
            $('#toDate').val('');
            table.search('').draw();
        });

        // Handle Add Transaction button click
        $(document).on('click', '#btnAddTransaction', function () {
            $('#modalTitle').text('Add Stock Out Transaction');
            $('#transactionId').val('0');
            $('#transactionForm')[0].reset();
            $('#transactionStatus').val('true');
            $('#transactionDate').val('');
            $('#projectId').val('0');
            $('#taskId').empty().append('<option value="0">Select Task</option>');
            loadItems(); // Reload items
            loadProjects(); // Reload projects
            showModal();
        });

        // Handle Edit button click
        $(document).on('click', '.edit-transaction', function () {
            var transactionId = $(this).data('transaction-id');
            editTransaction(transactionId);
        });

        // Function to edit transaction
        function editTransaction(transactionId) {
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/GetStockOutTransactionById?id=' + transactionId,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response && response.id) {
                        // Populate form with transaction data
                        $('#transactionId').val(response.id);
                        $('#itemId').val(response.itemId || '');
                        $('#quantity').val(response.quantity || 0);
                        $('#projectId').val(response.projectId || '0');
                        $('#taskId').val(response.taskId || '0');
                        $('#transactionStatus').val(response.isActive === true ? 'true' : 'false');
                        
                        // Set transaction date
                        if (response.transactionId) {
                            var date = new Date(response.transactionId);
                            if (!isNaN(date.getTime())) {
                                var year = date.getFullYear();
                                var month = ("0" + (date.getMonth() + 1)).slice(-2);
                                var day = ("0" + date.getDate()).slice(-2);
                                $('#transactionDate').val(year + '-' + month + '-' + day);
                            }
                        }
                        
                        // Load tasks for the selected project
                        if (response.projectId) {
                            loadTasks(response.projectId);
                        }
                        
                        $('#modalTitle').text('Edit Stock Out Transaction');
                        loadItems(); // Reload items
                        loadProjects(); // Reload projects
                        showModal();
                    } else {
                        alert('Transaction details not found');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading transaction:', error);
                    alert('An error occurred while loading transaction details. Please try again.');
                }
            });
        }

        // Handle Delete button click
        $(document).on('click', '.delete-transaction', function () {
            var transactionId = $(this).data('transaction-id');
            deleteTransaction(transactionId);
        });

        // Function to delete transaction
        function deleteTransaction(transactionId) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/DeleteStockOutTransaction',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(transactionId),
                success: function (response) {
                    if (response.httpStatusCode === 200) {
                        alert('Transaction deleted successfully!');
                        table.ajax.reload();
                    } else {
                        alert('Error deleting transaction: ' + (response.displayMessage || 'Unknown error'));
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error deleting transaction:', error);
                    alert('An error occurred while deleting the transaction. Please try again.');
                }
            });
        }

        // Handle form submission
        $(document).on('submit', '#transactionForm', function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Validate required fields
            var itemId = $('#itemId').val();
            var vendorId = $('#vendorId').val();
            var quantity = $('#quantity').val();
            var projectId = $('#projectId').val();
            var totalQuantity = $('#lblQuantity').html();
            // alert(itemId);
            // alert(vendorId);
            // alert(projectId);
            if (!itemId || itemId<=0) {
                alert('Please select an item');
                return;
            }
            if (!vendorId || vendorId<=0) {
                alert('Please select an vendor');
                return;
            }

            if (!quantity || parseFloat(quantity) <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            if (parseFloat(quantity) > parseFloat(totalQuantity)) {
                alert('Quantity could not more then total quantity ' + totalQuantity);
                $('#quantity').val(totalQuantity);
                return;
            }
            if (!projectId || projectId<= 0) {
                alert('Please select an project');
                return;
            }

            // Get transaction ID (0 for new transaction, actual ID for update)
            var transactionIdValue = parseInt($('#transactionId').val()) || 0;
            
            // Prepare the transaction data
            var transactionData = {
                Id: transactionIdValue,
                ItemId: parseInt(itemId),
                vendorId: parseInt(vendorId),
                Quantity: parseInt(quantity),
                ProjectId: parseInt($('#projectId').val()) || 0,
                TaskId: parseInt($('#taskId').val()) || 0,
                TransactionId: $('#transactionDate').val() || null,
                IsActive: $('#transactionStatus').val() === 'true'
            };

            // Show loading state
            var submitBtn = $('#btnSaveTransaction');
            submitBtn.prop('disabled', true).text('Saving...');

            // Call the API
            $.ajax({
                url: 'https://cmsapi.hrclicks.com/api/InventoryAPI/SaveStockOutTransaction',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(transactionData),
                success: function (response) {
                    if (response.httpStatusCode === 200) {
                        var message = transactionIdValue > 0 ? 'Transaction updated successfully!' : 'Transaction saved successfully!';
                        alert(message);
                        
                        // Close modal
                        if (typeof bootstrap !== 'undefined') {
                            var modalEl = document.getElementById('addEditTransactionModal');
                            var modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                        } else {
                            $('#addEditTransactionModal').modal('hide');
                        }
                        
                        // Reload table
                        table.ajax.reload();
                    } else {
                        var errorMessage = transactionIdValue > 0 ? 'Error updating transaction' : 'Error saving transaction';
                        alert(errorMessage);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    alert('An error occurred while saving the transaction. Please try again.');
                },
                complete: function () {
                    // Re-enable button
                    submitBtn.prop('disabled', false).text('Save Transaction');
                }
            });
        });

        // Function to show modal
        function showModal() {
            if (typeof bootstrap !== 'undefined') {
                // Bootstrap 5
                var modal = new bootstrap.Modal(document.getElementById('addEditTransactionModal'));
                modal.show();
            } else {
                // Bootstrap 4 or jQuery
                $('#addEditTransactionModal').modal('show');
            }
        }
    });
</script>
